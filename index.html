<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Seattle Redlining Map with Comparison</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.9.3/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.9.3/mapbox-gl.js"></script>
    <script
        src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-compare/v0.4.0/mapbox-gl-compare.js"></script>
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-compare/v0.4.0/mapbox-gl-compare.css"
        type="text/css">
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden; 
        }

        #comparison-container {
            display: flex;
            height: 100%;
            position: relative; 
            width: 100%;      
        }

        #before,
        #after {
            width: 100%; 
            flex-grow: 1;
        }

        #sidebar {
            width: 150px;
            flex-shrink: 0;
            height: 100%;
        }

        button {
            display: block;
            margin-bottom: 15px;
        }

        /* Styles for the maps within the comparison container */
        .map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .mapboxgl-compare {
            left: 0px;
        }
    </style>
</head>

<body>
    <div id="comparison-container">
        <div id="before" class="map"></div>
        <div id="after" class="map"></div>
         <div id="sidebar">
            <button id="fly-to-westseattle">Fly to West Seattle</button>
            <button id="reset-view">Reset</button>
            <button id="toggle-neighborhood-boundaries">Toggle Neighborhood Boundaries</button>
        </div>
    </div>

    <script>

        const initial_center = [-122.341919, 47.598645];
        const initial_zoom = 10;
        const bounds = [
            [-123.371258, 47.009962], //SW Coords
            [-121.616192, 48.046616] // NE Coords
        ];

        mapboxgl.accessToken = 'pk.eyJ1IjoiZWxqd3JpZ2h0IiwiYSI6ImNtNDduZnlweTA3dm4ybXNjY3R5anAyOGsifQ.gS6yn_JP5mcEIyF9wbgspw';

        // Historic HOLC Map
        const beforeMap = new mapboxgl.Map({
            container: 'before',
            style: 'mapbox://styles/mapbox/light-v11',
            center: initial_center,
            zoom: initial_zoom,
            projection: 'globe',
            maxBounds: bounds
        });

        beforeMap.on('load', () => {
            beforeMap.addSource('redlining_seattle', {
                type: 'geojson',
                data: 'data/redlining_seattle.geojson'
            });

            beforeMap.addSource('seattle_neighborhoods_Lhood', {
                type: 'geojson',
                data: 'data/seattle_neighborhoods_Lhood.geojson'
            });

            beforeMap.addLayer({
                id: 'seattle_neighborhoods_Lhood',
                type: 'line',
                source: 'seattle_neighborhoods_Lhood',
                paint: {'line-color': 'black'},
                layout: {visibility: 'visible'}
            });

            beforeMap.addLayer({
                id: 'redlining_seattle_fill',
                type: 'fill',
                source: 'redlining_seattle',
                paint: {
                    'fill-color': [
                        'match',
                        ['get', 'grade'],
                        'A', '#31af66',
                        'B', '#3b4cbf',
                        'C', '#c6ce55',
                        'D', '#d14d4d',
                        'grey'
                    ],
                    'fill-opacity': [
                        'case',
                        ['boolean', ['feature-state', 'hover'], false],
                        0.9,
                        0.7
                    ]
                },
                layout: {
                    visibility: 'visible'
                }
            });

            beforeMap.addLayer({
                id: 'redlining_seattle_line',
                type: 'line',
                source: 'redlining_seattle',
                paint: {
                    'line-color': [
                        'match',
                        ['get', 'grade'],
                        'A', '#31af66',
                        'B', '#3b4cbf',
                        'C', '#c6ce55',
                        'D', '#d14d4d',
                        'grey'
                    ],
                    'line-width': 1
                },
                layout: { visibility: 'visible' }
            });

            // beforeMap.on('mousemove', 'redlining_seattle_fill', (e) => {
            //     if (e.features.length > 0) {
            //         const featureId = e.features[0].properties.area_id;
            //         if (hoveredPolygonId !== null) {
            //             beforeMap.setFeatureState(
            //                 { source: 'redlining_seattle', id: hoveredPolygonId },
            //                 { hover: false }
            //             );
            //         }
            //         hoveredPolygonId = featureId;
            //         beforeMap.setFeatureState(
            //             { source: 'redlining_seattle', id: hoveredPolygonId },
            //             { hover: true}
            //         );
            //     }
            // });

            // beforeMap.on('mouseleave', 'redlining_seattle_fill', () => {
            //     if (hoveredPolygonId !== null) {
            //         beforeMap.setFeatureState(
            //             { source: 'redlining_seattle', id: hoveredPolygonId },
            //             { hover: false }
            //         );
            //     }
            //     hoveredPolygonId = null;
            // });

            beforeMap.on('click', (e) => {
                const [ selectedZone ] = beforeMap.queryRenderedFeatures(e.point, {
                    layers: ['redlining_seattle_fill']
                });

                if (selectedZone) {
                    const { label, grade } = selectedZone.properties
                    alert(`The grade of ${label} is ${grade}`)
                }
            })
        });
        // Modern Equity Index Map
        const afterMap = new mapboxgl.Map({
            container: 'after',
            style: 'mapbox://styles/mapbox/light-v11',
            center: initial_center,
            zoom: initial_zoom,
            projection: 'globe',
            maxBounds: bounds
        });

        afterMap.on('load', () => {
            afterMap.addSource('RSE_Index', {
                type: 'geojson',
                data: 'data/RSE_Index.geojson'
            });
 
            afterMap.addSource('seattle_neighborhoods_Lhood', {
                type: 'geojson',
                data: 'data/seattle_neighborhoods_Lhood.geojson'
            });

            afterMap.addLayer({
                id: 'seattle_neighborhoods_Lhood',
                type: 'line',
                source: 'seattle_neighborhoods_Lhood',
                paint: {'line-color': 'black'},
                layout: {visibility: 'visible'}
            });

            afterMap.addLayer({
                id: 'RSE_Index',
                type: 'fill',
                source: 'RSE_Index',
                paint: {
                    'fill-color': [
                        'match',
                        ['get', 'COMPOSITE_QUINTILE'],
                        'Highest Equity Priority', '#d14d4d',
                        'Second Highest', '#c6ce55',
                        'Middle', '#884fba',
                        'Second Lowest', '#3b4cbf',
                        'Lowest', '#31af66',
                        'gray'
                    ],
                    'fill-opacity': [
                        'case',
                        ['boolean', ['feature-state', 'hover'], false],
                        0.8,
                        0.7
                    ]},
                layout: {visibility: 'visible'}
            });

            afterMap.addLayer({
                id: 'RSE_Index',
                type: 'line',
                source: 'RSE_Index',
                paint: {'line-color': 'black'},
                layout: {visibility: 'visible'}
            });

        });
    
        // Comp Full Map
        const map = new mapboxgl.Compare(beforeMap, afterMap, '#comparison-container', {
            //mousemove: true // Enable for mousemove comparison, but it can be a bit much
        });

        // --- Toggle Neighborhood Boundaries ---
        document.querySelector('#toggle-neighborhood-boundaries').addEventListener('click', () => {
            const isVisible = beforeMap.getLayoutProperty('seattle_neighborhoods_Lhood', 'visibility') === 'visible';

            beforeMap.setLayoutProperty('seattle_neighborhoods_Lhood', 'visibility', isVisible ? 'none' : 'visible');
            afterMap.setLayoutProperty('seattle_neighborhoods_Lhood', 'visibility', isVisible ? 'none' : 'visible');
        });
    </script>
</body>

</html>